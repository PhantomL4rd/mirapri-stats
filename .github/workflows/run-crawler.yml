name: Run Crawler

on:
  workflow_dispatch: # Manual trigger
  schedule:
    # Every Wednesday at 00:00 UTC (09:00 JST), filtered to first week only
    - cron: '0 0 * * 3'

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  APP_NAME: mirapri-stats
  FLY_API_HOSTNAME: https://api.machines.dev

jobs:
  crawl:
    runs-on: ubuntu-latest
    steps:
      - name: Check if first Wednesday of month
        if: github.event_name == 'schedule'
        run: |
          DAY=$(date -u +%d)
          if [ "$DAY" -gt 7 ]; then
            echo "Not the first week of the month (day=$DAY), skipping."
            exit 1
          fi

      - uses: actions/checkout@v4

      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master
        with:
          version: latest

      - name: Build and push image
        id: build
        run: |
          OUTPUT=$(flyctl deploy --build-only --push \
            --app $APP_NAME \
            --dockerfile apps/scraper/Dockerfile \
            --config apps/scraper/fly.toml 2>&1)
          echo "$OUTPUT"
          # Extract image ref from output (remove @sha256:... suffix if present)
          IMAGE_REF=$(echo "$OUTPUT" | grep -oE 'registry\.fly\.io/[^[:space:]]+' | head -1 | sed 's/@sha256:.*//')
          if [ -z "$IMAGE_REF" ]; then
            echo "Failed to extract image ref"
            exit 1
          fi
          echo "ref=$IMAGE_REF" >> $GITHUB_OUTPUT
          echo "Image ref: $IMAGE_REF"
          # Wait for image to be available in registry
          sleep 30

      - name: Run crawler for Gaia
        env:
          IMAGE_REF: ${{ steps.build.outputs.ref }}
        run: |
          EXISTING=$(curl -sS \
            -H "Authorization: Bearer ${FLY_API_TOKEN}" \
            "${FLY_API_HOSTNAME}/v1/apps/${APP_NAME}/machines" | \
            jq '[.[] | select(.name | startswith("crawler-gaia-")) | select(.state == "started" or .state == "starting")] | length')
          if [ "$EXISTING" -gt "0" ]; then
            echo "Crawler for Gaia is already running, skipping"
            exit 0
          fi
          curl -sS -X POST \
            -H "Authorization: Bearer ${FLY_API_TOKEN}" \
            -H "Content-Type: application/json" \
            "${FLY_API_HOSTNAME}/v1/apps/${APP_NAME}/machines" \
            -d "{
              \"name\": \"crawler-gaia-$(date +%s)\",
              \"region\": \"nrt\",
              \"config\": {
                \"image\": \"${IMAGE_REF}\",
                \"init\": {
                  \"exec\": [\"node\", \"dist/crawler-cli.bundle.mjs\", \"--dc\", \"Gaia\"]
                },
                \"auto_destroy\": true,
                \"restart\": {
                  \"policy\": \"no\"
                },
                \"guest\": {
                  \"cpu_kind\": \"shared\",
                  \"cpus\": 1,
                  \"memory_mb\": 256
                }
              }
            }"

      - name: Run crawler for Mana
        env:
          IMAGE_REF: ${{ steps.build.outputs.ref }}
        run: |
          EXISTING=$(curl -sS \
            -H "Authorization: Bearer ${FLY_API_TOKEN}" \
            "${FLY_API_HOSTNAME}/v1/apps/${APP_NAME}/machines" | \
            jq '[.[] | select(.name | startswith("crawler-mana-")) | select(.state == "started" or .state == "starting")] | length')
          if [ "$EXISTING" -gt "0" ]; then
            echo "Crawler for Mana is already running, skipping"
            exit 0
          fi
          curl -sS -X POST \
            -H "Authorization: Bearer ${FLY_API_TOKEN}" \
            -H "Content-Type: application/json" \
            "${FLY_API_HOSTNAME}/v1/apps/${APP_NAME}/machines" \
            -d "{
              \"name\": \"crawler-mana-$(date +%s)\",
              \"region\": \"nrt\",
              \"config\": {
                \"image\": \"${IMAGE_REF}\",
                \"init\": {
                  \"exec\": [\"node\", \"dist/crawler-cli.bundle.mjs\", \"--dc\", \"Mana\"]
                },
                \"auto_destroy\": true,
                \"restart\": {
                  \"policy\": \"no\"
                },
                \"guest\": {
                  \"cpu_kind\": \"shared\",
                  \"cpus\": 1,
                  \"memory_mb\": 256
                }
              }
            }"

      - name: Run crawler for Elemental
        env:
          IMAGE_REF: ${{ steps.build.outputs.ref }}
        run: |
          EXISTING=$(curl -sS \
            -H "Authorization: Bearer ${FLY_API_TOKEN}" \
            "${FLY_API_HOSTNAME}/v1/apps/${APP_NAME}/machines" | \
            jq '[.[] | select(.name | startswith("crawler-elemental-")) | select(.state == "started" or .state == "starting")] | length')
          if [ "$EXISTING" -gt "0" ]; then
            echo "Crawler for Elemental is already running, skipping"
            exit 0
          fi
          curl -sS -X POST \
            -H "Authorization: Bearer ${FLY_API_TOKEN}" \
            -H "Content-Type: application/json" \
            "${FLY_API_HOSTNAME}/v1/apps/${APP_NAME}/machines" \
            -d "{
              \"name\": \"crawler-elemental-$(date +%s)\",
              \"region\": \"nrt\",
              \"config\": {
                \"image\": \"${IMAGE_REF}\",
                \"init\": {
                  \"exec\": [\"node\", \"dist/crawler-cli.bundle.mjs\", \"--dc\", \"Elemental\"]
                },
                \"auto_destroy\": true,
                \"restart\": {
                  \"policy\": \"no\"
                },
                \"guest\": {
                  \"cpu_kind\": \"shared\",
                  \"cpus\": 1,
                  \"memory_mb\": 256
                }
              }
            }"

      - name: Run crawler for Meteor
        env:
          IMAGE_REF: ${{ steps.build.outputs.ref }}
        run: |
          EXISTING=$(curl -sS \
            -H "Authorization: Bearer ${FLY_API_TOKEN}" \
            "${FLY_API_HOSTNAME}/v1/apps/${APP_NAME}/machines" | \
            jq '[.[] | select(.name | startswith("crawler-meteor-")) | select(.state == "started" or .state == "starting")] | length')
          if [ "$EXISTING" -gt "0" ]; then
            echo "Crawler for Meteor is already running, skipping"
            exit 0
          fi
          curl -sS -X POST \
            -H "Authorization: Bearer ${FLY_API_TOKEN}" \
            -H "Content-Type: application/json" \
            "${FLY_API_HOSTNAME}/v1/apps/${APP_NAME}/machines" \
            -d "{
              \"name\": \"crawler-meteor-$(date +%s)\",
              \"region\": \"nrt\",
              \"config\": {
                \"image\": \"${IMAGE_REF}\",
                \"init\": {
                  \"exec\": [\"node\", \"dist/crawler-cli.bundle.mjs\", \"--dc\", \"Meteor\"]
                },
                \"auto_destroy\": true,
                \"restart\": {
                  \"policy\": \"no\"
                },
                \"guest\": {
                  \"cpu_kind\": \"shared\",
                  \"cpus\": 1,
                  \"memory_mb\": 256
                }
              }
            }"
