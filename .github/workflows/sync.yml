name: Sync to D1

on:
  workflow_dispatch: # Manual trigger
  schedule:
    # Every Saturday at 00:00 UTC (09:00 JST)
    - cron: '0 0 * * 6'

jobs:
  sync:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.sync.outputs.status }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared
        run: pnpm -F @mirapri/shared build

      - name: Build sync
        run: pnpm -F @mirapri/sync build

      - name: Run sync
        id: sync
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          WORKER_URL: ${{ secrets.WORKER_URL }}
          WORKER_AUTH_TOKEN: ${{ secrets.WORKER_AUTH_TOKEN }}
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
        run: |
          OUTPUT=$(pnpm -F @mirapri/sync start 2>&1) || EXIT_CODE=$?
          echo "$OUTPUT"

          # Determine status based on output
          if echo "$OUTPUT" | grep -q "No crawl progress found"; then
            echo "status=no_progress" >> $GITHUB_OUTPUT
            echo "Status: no crawl progress found"
            exit 0
          elif echo "$OUTPUT" | grep -q "Scraper not finished yet"; then
            echo "status=in_progress" >> $GITHUB_OUTPUT
            echo "Status: crawler in progress"
            exit 0
          elif echo "$OUTPUT" | grep -q "Sync Complete"; then
            echo "status=complete" >> $GITHUB_OUTPUT
            echo "Status: sync complete"
          else
            echo "status=error" >> $GITHUB_OUTPUT
            echo "Status: unknown or error"
          fi

          # Exit with original exit code if there was an error
          if [ -n "$EXIT_CODE" ]; then
            exit $EXIT_CODE
          fi

  notify:
    needs: sync
    if: needs.sync.outputs.status == 'complete' || needs.sync.outputs.status == 'in_progress'
    runs-on: ubuntu-latest
    steps:
      - name: Notify Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SYNC_STATUS: ${{ needs.sync.outputs.status }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          if [ "$SYNC_STATUS" = "complete" ]; then
            EMOJI="âœ…"
            TITLE="é›†è¨ˆå®Œäº†"
            TEXT="ãƒŸãƒ©ãƒ—ãƒªçµ±è¨ˆã®é›†è¨ˆãŒå®Œäº†ã—ã¾ã—ãŸ"
          else
            EMOJI="ğŸ”„"
            TITLE="ã‚¯ãƒ­ãƒ¼ãƒ«ä¸­"
            TEXT="ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ãŒã¾ã å®Ÿè¡Œä¸­ã®ãŸã‚ã€é›†è¨ˆã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ"
          fi

          curl -sS -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"$EMOJI ãƒŸãƒ©ãƒ—ãƒªçµ±è¨ˆ: $TITLE\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"$EMOJI *ãƒŸãƒ©ãƒ—ãƒªçµ±è¨ˆ: $TITLE*\n\nâ€¢ $TEXT\nâ€¢ æ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S') UTC\nâ€¢ <${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}|ãƒ­ã‚°ã‚’ç¢ºèª>\"
                  }
                }
              ]
            }"
